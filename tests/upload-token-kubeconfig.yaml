---
- name: Upload kubeconfig to Vault (kv-v2)
  hosts: localhost
  gather_facts: false
  vars:
    vault_addr: "https://vault.demo-infra.example.com"
    vault_token: ""
    vault_mount: "apps"
    vault_path: "kubeconfig"
    kubeconfig_path: "~/.kube/kind-dev2"

  tasks:
    - name: Read local kubeconfig file
      ansible.builtin.slurp:
        src: "{{ kubeconfig_path }}"
      register: kubeconfig_file

    - name: Write kubeconfig into Vault kv-v2 path
      community.hashi_vault.vault_write:
        url: "{{ vault_addr }}"
        auth_method: token
        token: "{{ vault_token }}"
        path: "{{ vault_mount }}/data/{{ vault_path }}"
        validate_certs: false
        data:
          data:
            kubeconfig: "{{ kubeconfig_file['content'] | b64decode }}"
