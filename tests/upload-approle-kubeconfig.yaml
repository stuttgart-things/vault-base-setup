---
- name: Upload kubeconfig to Vault (kv-v2)
  hosts: localhost
  gather_facts: false
  vars:
    vault_addr: "https://vault.demo-infra.example.com"
    vault_mount: "kubeconfigs"
    vault_path: "kind-dev3"
    kubeconfig_path: "~/.kube/kind-dev3"
    vault_approle_id: "INSERT-HERE"
    vault_approle_secret: "INSERT-HERE" # pragma: allowlist secret

  tasks:
    - name: Read local kubeconfig file
      ansible.builtin.slurp:
        src: "{{ kubeconfig_path }}"
      register: kubeconfig_file

    - name: Write kubeconfig into Vault kv-v2 path
      community.hashi_vault.vault_write:
        url: "{{ vault_addr }}"
        auth_method: approle
        role_id: "{{ vault_approle_id }}"
        secret_id: "{{ vault_approle_secret }}"
        path: "{{ vault_mount }}/data/{{ vault_path }}"
        validate_certs: false
        data:
          data:
            kubeconfig: "{{ kubeconfig_file['content'] | b64decode }}"
